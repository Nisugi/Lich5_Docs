name: Generate Single File Documentation

on:
  workflow_dispatch:
    inputs:
      file_path:
        description: 'Path to Ruby file (e.g., lib/gemstone/psms/feat.rb)'
        required: true
        type: string
      provider:
        description: 'LLM Provider'
        required: false
        type: choice
        options:
          - openai
          - anthropic
        default: 'openai'
      source_repo:
        description: 'Source repository (owner/repo)'
        required: false
        type: string
        default: 'elanthia-online/lich-5'
      source_branch:
        description: 'Branch to use from source repository'
        required: false
        type: string
        default: 'main'

jobs:
  generate-single:
    runs-on: ubuntu-latest
    name: Generate Documentation for Single File

    permissions:
      contents: write  # Required to commit documented file

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Clone source repository
        run: |
          git clone https://github.com/${{ inputs.source_repo }}.git lich-source
          cd lich-source
          git checkout ${{ inputs.source_branch }}
          echo "âœ… Cloned ${{ inputs.source_repo }} (branch: ${{ inputs.source_branch }})"

      - name: Validate file exists
        id: validate
        run: |
          if [ ! -f "lich-source/${{ inputs.file_path }}" ]; then
            echo "Error: File not found: lich-source/${{ inputs.file_path }}"
            exit 1
          fi
          echo "file_name=$(basename ${{ inputs.file_path }})" >> $GITHUB_OUTPUT
          echo "âœ… File found: lich-source/${{ inputs.file_path }}"

      - name: Generate documentation
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          LLM_PROVIDER: ${{ inputs.provider }}
        run: |
          echo "Generating documentation for: ${{ inputs.file_path }}"
          echo "Provider: ${{ inputs.provider }}"
          echo "Output structure: mirror"

          # Run generate_docs.py with --file parameter and mirror structure
          python generate_docs.py \
            --file "lich-source/${{ inputs.file_path }}" \
            --provider ${{ inputs.provider }} \
            --output-structure mirror

      - name: Copy documented file
        run: |
          # Copy the documented file from output/latest/documented/ to documented/
          if [ -d "output/latest/documented" ]; then
            echo "Copying documented files to documented/ directory"
            mkdir -p documented
            cp -r output/latest/documented/* documented/ 2>/dev/null || true
            echo "âœ… Files copied to documented/"
          else
            echo "âš ï¸  No output/latest/documented directory found"
          fi

      - name: Verify output
        id: verify
        run: |
          # Find the documented file by searching for it
          # Mirror structure uses lich-source/lib as root, so lib/ is stripped
          file_name=$(basename "${{ inputs.file_path }}")

          # Search for the file in documented/ directory
          found_file=$(find documented/ -type f -name "$file_name" | head -1)

          if [ -n "$found_file" ] && [ -f "$found_file" ]; then
            echo "has_output=true" >> $GITHUB_OUTPUT
            echo "output_file=$found_file" >> $GITHUB_OUTPUT
            echo "âœ… Generated: $found_file"
          else
            echo "has_output=false" >> $GITHUB_OUTPUT
            echo "âŒ Output file not found: $file_name"
            echo "Contents of documented/ directory:"
            find documented/ -type f -name "*.rb" | head -20
            exit 1
          fi

      - name: Show diff
        if: steps.verify.outputs.has_output == 'true'
        run: |
          echo "### Documentation Changes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`diff" >> $GITHUB_STEP_SUMMARY

          if [ -f "${{ steps.verify.outputs.output_file }}" ]; then
            # Compare with original file from lich-source to show what was added
            git diff --no-index "lich-source/${{ inputs.file_path }}" "${{ steps.verify.outputs.output_file }}" | head -100 >> $GITHUB_STEP_SUMMARY || true
          fi

          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Commit documented file
        if: steps.verify.outputs.has_output == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add documented/
          git add output/latest/manifest.json || true  # Update manifest if exists

          if git diff --staged --quiet; then
            echo "No changes to commit (file may already be documented)"
          else
            git commit -m "$(cat <<'EOF'
          Generate documentation for ${{ steps.validate.outputs.file_name }}

          Generated YARD documentation for ${{ inputs.file_path }}
          Provider: ${{ inputs.provider }}

          ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

          Co-Authored-By: Claude <noreply@anthropic.com>
          EOF
          )"

            git push
            echo "âœ… Committed and pushed documented file"
          fi

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: single-file-output
          path: |
            documented/${{ inputs.file_path }}
            output/latest/manifest.json
            output/latest/*_failed_response.txt
          retention-days: 7

      - name: Summary
        if: always()
        run: |
          echo "### Single File Documentation Generation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**File:** \`${{ inputs.file_path }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Provider:** ${{ inputs.provider }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.verify.outputs.has_output }}" == "true" ]; then
            echo "**Status:** âœ… Success" >> $GITHUB_STEP_SUMMARY
            echo "**Output:** \`${{ steps.verify.outputs.output_file }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** âŒ Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the logs for errors." >> $GITHUB_STEP_SUMMARY
          fi
