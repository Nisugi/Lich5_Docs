name: Generate Batch Documentation

on:
  workflow_dispatch:
    inputs:
      provider:
        description: 'LLM Provider to use'
        required: true
        default: 'openai'
        type: choice
        options:
          - openai
          - anthropic
          - gemini
          - mock
      source_repo:
        description: 'Source repository (owner/repo)'
        required: true
        default: 'elanthia-online/lich-5'
      source_branch:
        description: 'Branch to document'
        required: true
        default: 'main'
      full_rebuild:
        description: 'Full rebuild (vs incremental)'
        required: true
        type: boolean
        default: false

jobs:
  generate-docs:
    runs-on: ubuntu-latest

    permissions:
      contents: write  # Required to commit to main branch

    steps:
    - name: Checkout documentation repo
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Clone Lich repository
      run: |
        git clone https://github.com/${{ inputs.source_repo }}.git lich-source
        cd lich-source
        git checkout ${{ inputs.source_branch }}

    - name: Validate environment
      env:
        LLM_PROVIDER: ${{ inputs.provider }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        python -c "
        import os
        import sys
        sys.path.insert(0, 'src')
        from providers import ProviderFactory

        validation = ProviderFactory.validate_environment()
        print(f'Provider: {validation[\"provider\"]}')
        print(f'Valid: {validation[\"valid\"]}')

        if not validation['valid']:
            print(f'Missing: {validation[\"missing\"]}')
            sys.exit(1)

        for warning in validation.get('warnings', []):
            print(f'Warning: {warning}')
        "

    - name: Download previous manifest (for incremental builds)
      if: inputs.full_rebuild == false
      continue-on-error: true
      uses: actions/download-artifact@v4
      with:
        name: documentation-output
        path: output/

    - name: Generate documentation
      env:
        LLM_PROVIDER: ${{ inputs.provider }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        echo "Generating documentation with ${{ inputs.provider }} provider"
        echo "Output structure: mirror (preserves source directory structure)"

        if [ "${{ inputs.full_rebuild }}" == "true" ]; then
          echo "Running FULL REBUILD (all files will be reprocessed)"
          python generate_docs.py lich-source/lib \
            --provider ${{ inputs.provider }} \
            --output-structure mirror \
            --force-rebuild \
            --output output/latest
        else
          echo "Running INCREMENTAL build (skipping already processed files)"
          python generate_docs.py lich-source/lib \
            --provider ${{ inputs.provider }} \
            --output-structure mirror \
            --output output/latest
        fi

    - name: Copy documented files to repo root
      run: |
        # Copy mirrored documented files to repo root (for committing to main)
        echo "Copying documented files from output/latest/documented/ to documented/"
        mkdir -p documented
        cp -r output/latest/documented/* documented/ 2>/dev/null || echo "No documented files found"

        # Show structure
        echo "Documented files structure:"
        find documented/ -name "*.rb" | head -20 || true

    - name: Clean up cloned repository
      run: |
        # Remove the cloned Lich repository to avoid committing it
        rm -rf lich-source
        echo "Cleaned up lich-source directory"

    - name: Commit documented files to main
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        # Add documented files only (HTML generation happens in separate workflow)
        git add documented/
        git add output/latest/manifest.json || true

        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          # Get statistics for commit message
          DOCUMENTED_COUNT=$(find documented/ -name "*.rb" | wc -l)

          git commit -m "$(cat <<'EOF'
        Generate documentation from ${{ inputs.source_repo }}

        Generated YARD-documented Ruby files.

        - Provider: ${{ inputs.provider }}
        - Source: ${{ inputs.source_repo }} @ ${{ inputs.source_branch }}
        - Type: ${{ inputs.full_rebuild && 'Full rebuild' || 'Incremental' }}
        - Files documented: ${DOCUMENTED_COUNT}
        - Output structure: Mirror (preserves source directory hierarchy)

        Documented files committed to documented/ directory.
        HTML documentation will be generated by build-html workflow.

        ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

        Co-Authored-By: Claude <noreply@anthropic.com>
        EOF
        )"

          git push
          echo "âœ… Changes committed and pushed to main branch"
          echo "ðŸ“„ HTML generation will be triggered automatically by build-html.yml workflow"
        fi

    - name: Upload artifacts (for next incremental run)
      uses: actions/upload-artifact@v4
      with:
        name: documentation-output
        path: output/
        retention-days: 7

    - name: Upload artifacts (historical)
      uses: actions/upload-artifact@v4
      with:
        name: documentation-${{ github.run_number }}
        path: output/
        retention-days: 30

    - name: Summary
      if: always()
      run: |
        echo "### Documentation Generation Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Provider:** ${{ inputs.provider }}" >> $GITHUB_STEP_SUMMARY
        echo "**Source:** ${{ inputs.source_repo }} @ ${{ inputs.source_branch }}" >> $GITHUB_STEP_SUMMARY
        echo "**Type:** ${{ inputs.full_rebuild && 'Full rebuild' || 'Incremental' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -d "documented" ]; then
          DOCUMENTED_COUNT=$(find documented/ -name "*.rb" | wc -l)
          echo "**Documented files:** $DOCUMENTED_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Documented Ruby files committed to \`documented/\` directory" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“„ **Next:** The \`build-html.yml\` workflow will automatically trigger" >> $GITHUB_STEP_SUMMARY
          echo "to generate HTML documentation from these files." >> $GITHUB_STEP_SUMMARY
        fi